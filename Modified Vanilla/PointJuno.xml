<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>
<!---
    Sandbox changes
        Changed the point juno station to a generic CW fortress
        Removed the 'save point juno' mission
        removed the CSC Europa (and lamplighter prototype
--->


	<!-- Point Juno 
	
	GLOBAL DATA
	
	status:			Status of Point Juno
						Nil					Unknown
						'defended			Player saved Point Juno
						'destroyed			Point Juno destroyed by Ares
						'destroyedByPlayer	Point Juno destroyed by player

	EXTRA DATA

	AlphaFleet:		Alpha fleet leader
	MissionIntro:	If True, then we've told the player about the mission
	MissionStatus:	Status of the mission:
						Nil					Mission has not started yet
						"defaultAttack"		Player did not dock before attack started
						"findBeta"			Player must find the hidden beta fleet and destroy it
						"destroyBeta"		Alpha destroyed; player must destroy beta fleet
						"destroyAlpha"		Beta destroyed; player must destroy alpha (which is attacking)
						"oneLastAttack"		Alpha and beta destroyed; player must dock to get gamma mission
						"destroyGamma"		Alpha and beta destroyed; player must destroy gamma
						"celebrate"			Alpha, beta, and gamma destroyed
						"europa"			Tell the player about Project lamplighter
						"europaAccepted"	Player has accepted mission
						"europaDeclined"	Player has declined mission
						"complete"			Mission done
						"PointJunoLost"		Point Juno destroyed
	-->

	<StationType UNID="&stPointJuno;"
			name=				"Point Juno"
			sovereign=			"&svCommonwealth;"
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"
			defaultBackgroundID="&rsPointJunoBkgnd;"
			canAttack=			"true"
			noBlacklist=		"true"

			multiHull=			"true"
			armorID=			"&itP1000HexphaseArmor;"
			maxHitPoints=		"500"
			hitPoints=			"500"
			repairRate=			"2"
			shipRepairRate=		"3"
			explosionType=		"&vtThermoExplosion3;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"commonwealth,commonMilitary,commonFleet,fleetDelivery,friendly,pointJuno,populated"
			level=				"8"

			noArticle=			"true"
			>

		<Image			imageID="&rsStationsPointJuno;" imageX="0" imageY="0" imageWidth="208" imageHeight="256"/>

		<Items>
			<RandomItem count="2d4" 
					criteria=		"w -Illegal; -Alien; -Specialty; -NotForSale"
					level=			"5"
					levelCurve=		"1"
					/>

			<RandomItem count="1d4" 
					criteria=		"w -Illegal; -Alien; -Specialty; -NotForSale"
					level=			"6"
					levelCurve=		"1"
					/>

			<RandomItem count="1d4" 
					criteria=		"s -Illegal; -Alien; -Specialty; -NotForSale"
					level=			"6"
					levelCurve=		"1"
					/>

			<RandomItem count="1d4" 
					criteria=		"s -Illegal; -Alien; -Specialty; -NotForSale"
					level=			"6"
					levelCurve=		"1"
					/>

			<RandomItem count="2d4" 
					criteria=		"a -Illegal; -Alien; -Specialty; -NotForSale"
					level=			"6"
					levelCurve=		"1"
					/>

			<Item				count="16d20"	item="&itKM500Missile;" />
			<Item				count="8d20"	item="&itKM550Missile;" />
			<Item				count="8d20"	item="&itXM900Missile;" />
		</Items>
        
		<Ships>
			<Ship					count="1"	class="&scBritannia;"	orders="guard" controller="fleetcommand">
				<Escorts>
					<Ship			count="12"	class="&scCenturion;"	orders="escort" controller="fleet"/>
				</Escorts>
			</Ship>
			<Ship					count="1"	class="&scBritannia;"	orders="guard" controller="fleetcommand">
				<Escorts>
					<Ship			count="12"	class="&scCenturion;"	orders="escort" controller="fleet"/>
				</Escorts>
			</Ship>
		</Ships>

		<Reinforcements minShips="5">
			<Table>
				<Ship chance="25" count="1" class="&scEI500;" orders="gateOnThreat"/>
				<Ship chance="10" count="1" class="&scWolfen;" orders="gateOnThreat"/>
				<Ship chance="15" count="1" class="&scRoninC;" orders="guard"/>
				<Ship chance="50" count="1" class="&scCenturion;" orders="guard"/>
			</Table>
		</Reinforcements>

		<StaticData>
			<Missions0>
				(
					("mission0a"
						; Code to describe mission
						(lambda Nil
							(block (gateList)
								(setq gStart Nil)

								; Get the list of gates in the system
								(setq gateList (sysFindObject gSource "G -uncharted;"))

								; Make sure there are at least 2 gates
								(if (geq (count gateList) 2)
									(block Nil
										(setq gStart (item gateList 0))
										(setq gEnd (item gateList 1))

										; The two gates better be at least 50 light-seconds
										; away from each other
										(if (ls (objGetDistance gStart gEnd) 50)
											(setq gStart Nil)
											)
										)
									)

								; If we have a destination, then compose briefing
								(if gStart
									(cat "\"Your mission is to patrol the orbital lanes that access the major stargates. Your patrol will take you in a circuit through the system that passes each stargate and returns back here. Your orders are to destroy any enemy ships in the lanes. Understood?\"")
									Nil
									)
								)
							)

						; Code to initiate mission
						(lambda Nil
							(block (waypoint)
								; Remember where were supposed to go
								(objSetObjRefData gSource "StartGate" gStart)
								(objSetObjRefData gSource "EndGate" gEnd)

								; First waypoint is the nav beacon
								(setq waypoint (objGetObjRefData gStart "NavBeacon"))

								; Set the target in the player ship's computer
								(shpOrderEscort gPlayerShip waypoint)

								; Prepare the station to be reconned
								(staClearReconned waypoint)
								(staSetFireReconEvent waypoint)
								(objRegisterForEvents gSource waypoint)

								; Create some marauders at the waypoint and send them
								; towards the player
								(if (leq (random 1 100) 60)
									(sysAddEncounterEvent 0 gPlayerShip &etMarauderAmbush2; waypoint)
									)

								; Remember which waypoint we want
								(objSetData gSource "Waypoint" 1)
								)
							)
						)
					)
			</Missions0>

			<Missions1>
				(
					("mission1a"
						; Code to describe mission
						(lambda Nil
							(block (gateList)
								(setq gStart Nil)
								
								; Get the list of gates in the system
								(setq gateList (sysFindObject gSource "G -uncharted;"))

								; If there are a least 2 gates, figure out which should
								; be start and end.
								(if (geq (count gateList) 2)
									(block Nil
										(setq gStart (item gateList 0))
										(setq gEnd (item gateList 1))

										; The nearest gate is the first gate
										(if (ls (objGetDistance gSource gEnd) (objGetDistance gSource gStart))
											(block (swap)
												(setq swap gStart)
												(setq gStart gEnd)
												(setq gEnd swap)
												)
											)

										; The two gates better be at least 150 light-seconds
										; away from each other
										(if	(ls (objGetDistance gStart gEnd) 150)
											(setq gStart Nil)
											)
										)
									)
									
								; The enemy that we must intercept is random

								(if gStart
									(block (roll)
										(setq roll (random 1 100))
										(switch
											(leq roll 50)
												(block Nil
													(objSetData gSource "Enemy" 'marauders)
													(cat "\"We have received information that a marauder convoy will be entering the system at the " (objGetName gStart) ". Your mission is to destroy the convoy before it leaves the system.\"")
													)

											(block Nil		
												(objSetData gSource "Enemy" 'slavers)
												(cat "\"We have received information that a slaver convoy will be entering the system at the " (objGetName gStart) ". Your mission is to destroy the convoy before it leaves the system.\"")
												)
											)
										)
									Nil
									)
								)
							)

						; Code to initiate mission
						(lambda Nil
							(block (timer travelTime)
								(objSetObjRefData gSource "StartGate" gStart)
								(objSetObjRefData gSource "EndGate" gEnd)
								
								; Compute how long it will take for the player to get to the first gate
								(setq travelTime (sysCalcTravelTime (objGetDistance gSource gStart) (shpGetMaxSpeed gPlayerShip)))

								(setq timer (add (max travelTime 600) (random 0 100)))
								(sysAddObjTimerEvent timer gSource "OnTimerConvoyAppears")

								(shpOrderEscort gPlayerShip gStart)
								)
							)
						)
						
					("mission1b"
						; Code to describe mission
						(lambda Nil
							(block (allEnemyStations)
								(setq allEnemyStations (sysFindObject gSource "TAE +populated; &gt;=4 &lt;=5 -outlawMiners; -penitents;"))
									
								; If we've found an enemy station, then send player to kill it
								(setq gStart (random allEnemyStations))
								
								(if gStart
									(cat
										"\"" (objGetName gStart 0x05) " in the system has been harrassing traffic in the area. "
										"We want you to take it out. Clear?\""
										)
									Nil
									)
								)
							)
							
						; Code to initiate mission
						(lambda Nil
							(block Nil
								; Remember the target
								(objSetObjRefData gSource "Target" gStart)
								(objRegisterForEvents gSource gStart)
								
								; Point the player
								(shpCancelOrders gPlayerShip)
								(shpOrder gPlayerShip 'attack gStart)
								)
							)
						)
					)
			</Missions1>

			<Missions2>
				(
					("mission2a"
						; Code to describe mission
						(lambda Nil
							(block Nil
								"We're receiving a distress signal from a super-freighter at the edge of the system. Check it out, and if necessary, escort the freighter back. We'll feed the coordinates into your computer. What are standing around for? Get moving!"
								)
							)

						; Code to initiate mission
						(lambda Nil
							(block (pos ship timer vec1)
								; unit vector from origin to station
								(setq vec1 (sysVectorDivide (objGetPos gSource) (objGetDistance gSource)))

								; position of freighter
								(setq pos (sysVectorAdd (objGetPos gSource) (sysVectorMultiply vec1 (random 450 500))))

								; Create the freighter with orders to dock at fortress
								(setq ship (sysCreateShip &scScarabFreighter; pos &svCommonwealth;))
								(objSetData ship "noPiracyCheck" True)
								(shpOrderDock ship gSource)
								(shpOrderWait ship (random 10 60))
								(shpOrderGate ship)

								; Remember this ship
								(objSetObjRefData gSource "Target" ship)

								; register so we know when the transport is destroyed
								(objRegisterForEvents gSource ship)

								; Point the player to the transport
								(shpCancelOrders gPlayerShip)
								(shpOrderEscort gPlayerShip ship)
								(objSetIdentified ship)

								; Create an enemy ship that will attack the freighter
								(for i 1 (random 2 3)
									(block (enemy)
										(setq enemy (sysCreateShip &scViking-II; (sysVectorPolarOffset ship (random 0 359) 300) &svMarauders;))
										(shpOrderAttack enemy ship)
										)
									)

								; On timer, more enemies appear
								(sysAddEncounterEventAtDist 
									(add 800 (random 0 600)) 
									ship 
									&etMarauderAmbush1; 
									(random 120 200)
									)

								(sysAddEncounterEventAtDist 
									(add 1200 (random 0 500)) 
									gPlayerShip 
									&etMarauderAmbush2; 
									(random 120 200)
									)

								(sysAddEncounterEventAtDist 
									(add 1800 (random 0 100)) 
									gPlayerShip 
									&etMarauderAmbush2; 
									(random 120 200)
									)

								(sysAddEncounterEventAtDist 
									(add 1900 (random 0 100)) 
									ship
									&etMarauderAmbush2; 
									(random 120 200)
									)
								)
							)
						)
					)
			</Missions2>

			<NPCService>
				(	;	service					level	margin
					(	'repairArmor			8		100		)
					)
			</NPCService>

			<Rumors>
				(
					"A man with a prosthetic arm sits next to you: \"I've been flying for the militia for years, but I'd much rather be helping the Fleet. No one's seen them in a long time. They must be at the Ares Homeworld by now.\""
					"A man and a woman sit next to you. The woman starts a conversation with you: \"We're students from St. Katharine's Star! It's so exciting to be here where all the action is! We're writing a doctoral thesis on the role of minority neo-humans on reductive militia policy. Wish us luck!\""
					"An older pilot sits next to you: \"Don't underestimate the slavers! We've been fighting them for years and they just keep advancing their technology. There are rumors that they've developed a new archcannon powered by their longzhu spheres.\""
					"A woman sits next to you: \"My husband is in the Commonwealth Fleet and I haven't seen him for years. Sometimes I get messages from him, but it's never good news.\""
					"A young man wearing trendy clothes talks with you: \"I think that girl in the flight suit likes me. What do you think?\""
					"A well-dressed woman sits next to you: \"You're heading to the galactic what? I don't know&#x97;sounds like brainwashing to me.\""
					"A short-haired woman talks to you: \"My cousin's best friend says that the CSC Europa got blown up by the Ares. They should pull back the Fleet and have them fight the slavers! You know what I mean? What's the point?\""
					"A short, round man sits next to you: \"You're going to the Core? Elegant! Maybe you'll get to meet the aliens.\""
					"A dark-skinned woman talks with you: \"My best friend went to the Core; it was two years ago, I think. A year later they found her wreckage in the Sanctuary system; she left me a message, but I've never been able to read it.\""
					"A tall woman talks to you: \"I'm doing research on the Iocrym. It is curious, don't you think, that they haven't returned? A lot of ignorant people think they are preparing to invade, which is ridiculous. They wouldn't travel thousands of light-years just to kill us. Why bother?\""
					"A young woman sits next to you: \"Why does Domina compel you to go to the Core? I suppose you won't find out until you get there. Still, it's nice to have a purpose in life.\""
					)
			</Rumors>

		</StaticData>

		<Events>
			<GetGlobalAchievements>
				(block (theList rank)
					(setq rank (objGetData gPlayerShip "militiaRank"))
					
					(if (gr rank 0)
						(setq theList (list
							(list
								"Commonwealth militia rank"
								(switch
									(eq rank -1) "Blacklisted"
									(eq rank 1) "Lieutenant"
									(eq rank 2) "Major"
									(eq rank 3) "Colonel"
									(cat "ERROR: Militia rank: " rank)
									) 
								)
								
							(list
								"Commonwealth militia missions"
								(intMissionAchievementString (typGetGlobalData &stCommonwealthFortress; "missionsCompleted") (typGetGlobalData &stCommonwealthFortress; "missionsFailed"))
								"missions &amp; activities"
								)
							))
						)
						
					theList
					)
			</GetGlobalAchievements>

			<OnCreate>
				(block (gate gateList count)
					; Get the list of gates in the system
					(setq gateList (sysFindObject gSource "G -uncharted;"))

					; Place nav beacons between us and the stargates in this system
					(setq count 0)
					(enum gateList gate
						(block (beacon)
							(setq beacon
								(sysCreateStation &stNavBeacon;
									(sysVectorAdd 
										(objGetPos gSource)
										(sysVectorDivide 
											(sysVectorSubtract 
												(objGetPos gate) 
												(objGetPos gSource)
												)
											2
											)
										)
									)
								)

							; Name the nav beacons
							(if (ls count 5)
								(objSetName beacon
									(cat "NavBeacon " (item '('Alpha 'Beta 'Gamma 'Delta 'Epsilon) count))
									)
								)

							; Remember which NavBeacon goes with each gate
							(objSetObjRefData gate "NavBeacon" beacon)

							(setq count (add count 1))
							)
						)
					)
			</OnCreate>

			<OnDestroy>
				(intCommonwealthOnDestroy)
			</OnDestroy>

			<OnObjDestroyed>
				(if (eq (objGetData gSource "MissionStatus") "inprogress")
					(block (missionID)
						(setq missionID (objGetData gSource "MissionID"))
						(switch
							; If the player was destroyed, stop the mission
							(eq aObjDestroyed gPlayerShip)
								(block Nil
									(objSetData gSource "MissionStatus" "failure")
									(typIncGlobalData &stCommonwealthFortress; "missionsFailed")
									(plyMessage gPlayer "Mission failed")
									(shpCancelOrders gPlayerShip)
									)

							(eq missionID "mission1a")
								(block (theShip)
									(setq theShip (objGetObjRefData gSource "ShipToDestroy"))

									; If the ship has been destroyed, then we succeeded
									(if (eq aObjDestroyed theShip)
										(block Nil
											(objSetData gSource "MissionStatus" "success")
											(typIncGlobalData &stCommonwealthFortress; "missionsCompleted")
											(plyMessage gPlayer "Mission complete!")
											)
										)
									)
									
							(eq missionID "mission1b")
								; If the target has been destroyed, then we succeeded
								(if (eq aObjDestroyed (objGetObjRefData gSource "Target"))
									(block Nil
										(objSetData gSource "MissionStatus" "success")
										(typIncGlobalData &stCommonwealthFortress; "missionsCompleted")
										(plyMessage gPlayer "Mission complete!")
										(shpCancelOrders gPlayerShip)
										)
									)
							
							(eq missionID "mission2a")
								(block (theShip)
									(setq theShip (objGetObjRefData gSource "Target"))

									; If the freighter was destroyed, we fail
									(if (eq aObjDestroyed theShip)
										(block Nil
											(objSetData gSource "MissionStatus" "failure")
											(typIncGlobalData &stCommonwealthFortress; "missionsFailed")
											(plyMessage gPlayer "Mission failed")
											)
										)
									)
							)
						)
					)
			</OnObjDestroyed>

			<OnObjDocked>
				(if (eq (objGetData gSource "MissionStatus") "inprogress")
					(block (missionID)
						(setq missionID (objGetData gSource "MissionID"))
						(switch
							(eq missionID "mission2a")
								(if (eq aObjDocked (objGetObjRefData gSource "Target"))
									(block Nil
										(objSetData gSource "MissionStatus" "success")
										(typIncGlobalData &stCommonwealthFortress; "missionsCompleted")
										(plyMessage gPlayer "Mission complete!")
										(shpCancelOrders gPlayerShip)
										)
									)
							)
						)
					)
			</OnObjDocked>

			<OnObjEnteredGate>
				(if (eq (objGetData gSource "MissionStatus") "inprogress")
					(block (missionID)
						(setq missionID (objGetData gSource "MissionID"))
						(switch
							(eq missionID "mission1a")
								(block (theShip)
									(setq theShip (objGetObjRefData gSource "ShipToDestroy"))

									; If the ship managed to gate out then the mission has failed
									(if (eq aObj theShip)
										(block Nil
											(objSetData gSource "MissionStatus" "failure")
											(typIncGlobalData &stCommonwealthFortress; "missionsFailed")
											(plyMessage gPlayer "Mission failed")
											)
										)
									)
							)
						)
					)
			</OnObjEnteredGate>

			<OnObjReconned>
				(if (eq (objGetData gSource "MissionStatus") "inprogress")
					(block (missionID)
						(setq missionID (objGetData gSource "MissionID"))
						(switch
							(eq missionID "mission0a")
								(block (waypoint nextWaypoint)
									; Unregister
									(objUnregisterForEvents gSource aObj)
									(shpCancelOrders gPlayerShip)

									; Next waypoint
									(setq waypoint (objGetData gSource "Waypoint"))
									(switch
										(eq waypoint 1)
											(setq nextWaypoint (objGetObjRefData gSource "StartGate"))

										(eq waypoint 2)
											(setq nextWaypoint (objGetObjRefData gSource "EndGate"))

										(eq waypoint 3)
											(setq nextWaypoint (objGetObjRefData (objGetObjRefData gSource "EndGate") "NavBeacon"))

										(eq waypoint 4)
											(setq nextWaypoint gSource)

										(setq nextWaypoint Nil)
										)

									(if nextWaypoint
										; If we're not done, then prepare the next encounter
										(block Nil
											; Set the target in the player ship's computer
											(shpOrderEscort gPlayerShip nextWaypoint)

											; Prepare the station to be reconned
											(staClearReconned nextWaypoint)
											(staSetFireReconEvent nextWaypoint)
											(objRegisterForEvents gSource nextWaypoint)

											; Create some marauders at the waypoint and send them
											; towards the player
											(if (leq (random 1 100) 60)
												(sysAddEncounterEvent 0 gPlayerShip &etMarauderAmbush1; nextWaypoint)
												)

											; Remember which waypoint we want
											(objIncData gSource "Waypoint")
											)

										; Otherwise, mission is done
										(block Nil
											(objSetData gSource "MissionStatus" "success")
											(typIncGlobalData &stCommonwealthFortress; "missionsCompleted")
											(plyMessage gPlayer "Mission complete!")
											)
										)
									)
							)
						)
					)
			</OnObjReconned>

			<OnTimerConvoyAppears>
				(block (ship)
					(switch
						(eq (objGetData gSource "Enemy") 'marauders)
							(block Nil
								; create the main ship that will go from one stargate to the other
								(setq ship (sysCreateShip &scDrake; (objGetObjRefData gSource "StartGate") &svMarauders;))
								(shpOrderGate ship (objGetObjRefData gSource "EndGate"))

								; create the escorts
								(for i 1 (random 3 6)
									(block (escort)
										(setq escort (sysCreateShip &scViking-II; (objGetObjRefData gSource "StartGate") &svMarauders;))
										(shpOrderEscort escort ship)
										)
									)
								)

						(block Nil
							; create the transport that will go from one stargate to the other
							(setq ship (sysCreateShip &scSungTransport; (objGetObjRefData gSource "StartGate") &svSung;))
							(shpOrderGate ship (objGetObjRefData gSource "EndGate"))
							(objAddItem ship (itmCreate &itSlaveCoffin; (random 10 20)))

							; create the escorts
							(for i 1 (random 6 9)
								(block (escort)
									(setq escort (sysCreateShip &scWindSlaver; (objGetObjRefData gSource "StartGate") &svSung;))
									(shpOrderEscort escort ship)
									)
								)
							)
						)

					; register so we know when the main ship is destroyed
					(objRegisterForEvents gSource ship)
					(objSetObjRefData gSource "ShipToDestroy" ship)

					; orders
					(shpCancelOrders gPlayerShip)
					(shpOrderAttack gPlayerShip ship)
					(objSetIdentified ship)
					)
			</OnTimerConvoyAppears>
		</Events>

		<DockScreens>
			<Main
				name=			"=(objGetName gSource)"
				>

				<OnInit>
					(intCommonwealthOnInit "Main")
				</OnInit>

				<InitialPane>
					(block (missionStatus)
						(setq missionStatus (objGetData gSource "MissionStatus"))
						(switch
							(eq missionStatus "inprogress")
								"MissionInProgress"

							(eq missionStatus "failure")
								"MissionFailure"

							(eq missionStatus "success")
								"MissionSuccess"

							"Default"
							)
						)
				</InitialPane>

				<Panes>
					<Default>
						<Initialize>
							(block (desc playerRank)
								; Make sure playerRank variable is initialized
								(setq playerRank (milInit))

								; Set the greeting based on the player's rank
								(setq desc "You are in the main hall of a Commonwealth Militia Fortress.")

								(switch
									(eq playerRank 1)
										(setq desc (cat desc " Squadron captains rush through the hall reading mission briefings and weapons manifests."))

									(eq playerRank 2)
										(setq desc (cat desc " Squadron captains rush through the hall on various missions; several stop to say hello to you. You feel like you belong."))

									(eq playerRank 3)
										(setq desc (cat desc " Squadron captains rush through the hall on various missions, each one stops to salute you as you pass."))

									(setq desc (cat desc " Squadron captains rush through the hall reading mission briefings and weapons manifests. You feel out of place here."))
									)
								(scrSetDesc gScreen desc)
								)
						</Initialize>

						<Actions>
							<Action name="Command Center" default="1" key="C">
								(if (milCanEnterCC)
									(scrShowPane gScreen "CommandCenter")
									(scrShowPane gScreen "AccessDenied")
									)
							</Action>

							<Action name="Armory" key="A">
								(if (gr (objGetData gPlayerShip "militiaRank") 0)
									(scrShowPane gScreen "Armory")
									(scrShowPane gScreen "AccessDenied2")
									)
							</Action>

							<Action name="Dock Services" key="D">
								<ShowPane pane="DockServices"/>
							</Action>

							<Action name="Officer's Club" key="O">
								(if (gr (objGetData gPlayerShip "militiaRank") 0)
									(scrShowPane gScreen "OfficersClub")
									(scrShowPane gScreen "AccessDenied3")
									)
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>

					</Default>

					<AccessDenied>
						<Initialize>
							(scrSetDesc gScreen "Two guards flank the door to the Command Center. One of them checks your ID against a computer list: \"Sorry, %sir%, only experienced captains are allowed inside.\"")
						</Initialize>

						<Actions>
							<Action name="Leave" default="1" cancel="1" key="L">
								<ShowPane pane="Default"/>
							</Action>
						</Actions>
					</AccessDenied>

					<AccessDenied2>
						<Initialize>
							(scrSetDesc gScreen "Two guards flank the door to the Armory. One of them checks your ID against a computer list: \"Sorry, %sir%, only officers are allowed in the armory.\"")
						</Initialize>

						<Actions>
							<Action name="Leave" default="1" cancel="1" key="L">
								<ShowPane pane="Default"/>
							</Action>
						</Actions>
					</AccessDenied2>

					<AccessDenied3>
						<Initialize>
							(scrSetDesc gScreen "Two guards flank the door to the Officer's Club. One of them checks your ID against a computer list: \"Sorry, %sir%, only officers are allowed in the club.\"")
						</Initialize>

						<Actions>
							<Action name="Leave" default="1" cancel="1" key="L">
								<ShowPane pane="Default"/>
							</Action>
						</Actions>
					</AccessDenied3>

					<Armory desc="You are in the station's armory shop. You may buy weapons and armor to equip your ship.">
						<Actions>
							<Action name="Buy items" default="1" key="B">
								(comShowBuyScreen 
									(lambda (thisItem)
										(block (rank)
											(setq rank (objGetData gPlayerShip "militiaRank"))
											(switch
												(or (itmIsDamaged thisItem) (itmIsInstalled thisItem))
													Nil

												(itmHasModifier thisItem 'Illegal)
													Nil

												; Some items only available to Majors
												(or (eq (itmGetUNID thisItem) &itXM900Missile;)
														(eq (itmGetUNID thisItem) &itStarCannon;)
														)
													(if (gr rank 1)
														(itmGetPrice thisItem)
														Nil
														)

												; Other items are available at a discount depending on level
												(eq rank 1)
													(divide (multiply (itmGetPrice thisItem) 90) 100)

												(eq rank 2)
													(divide (multiply (itmGetPrice thisItem) 75) 100)

												(eq rank 3)
													(divide (multiply (itmGetPrice thisItem) 55) 100)

												; item not available
												Nil
												)
											)
										)
										
									"Main"					; return screen
									)
							</Action>

							<Action name="Leave" cancel="1" key="L">
								<ShowPane pane="Default"/>
							</Action>

						</Actions>

					</Armory>

					<CommandCenter
							desc="You are in the command center surrounded by wall maps and scanner displays. The commanding officer of the fortress looks up from his charts and asks, &quot;Are you looking for a mission, captain?&quot;">

						<Actions>
							<Action name="&quot;Yes sir, I'm ready.&quot;" default="1" key="Y">
								(block (playerRank)
									(setq playerRank (objGetData gPlayerShip "militiaRank"))
									(if (eq playerRank -1)
										(scrShowPane gScreen "TooManyFailures")
										(block Nil
											(setq gPrevScreen "Main")
											(setq gPrevPane "Default")
											(setq gMissionTitle Nil)
											(setq gMissionListName (cat "Missions" (objGetData gPlayerShip "militiaRank")))
											(setq gMissionNoneText "\"Sorry, there are no missions currently available.\"")
											(setq gMissionAcceptText "\"Good luck, captain!\"")
											(setq gMissionDeclineText "\"Why don't you make yourself useful and get us some tea or something.\"")
											(scrShowScreen gScreen "&dsMission;")
											)
										)
									)
							</Action>

							<Action name="&quot;No sir, I'm just looking.&quot;" cancel="1" key="N">
								<ShowPane pane="GetOut"/>
							</Action>
						</Actions>
					</CommandCenter>

					<GetOut
							desc="&quot;Why don't you make yourself useful and get us some tea or something.&quot;">

						<Actions>
							<Action name="Leave" default="1" cancel="1" key="L">
								<ShowPane pane="Default"/>
							</Action>
						</Actions>
					</GetOut>

					<MissionFailure
							desc="&quot;You screwed that mission all the way to Sol and back. You better hit the sims, pilot!&quot;">

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block (success failure)
									(objSetData gSource "MissionStatus" Nil)

									(setq success (objGetData gPlayerShip "militiaSuccess"))
									(setq failure (add (objGetData gPlayerShip "militiaFailure") 1))
									(objSetData gPlayerShip "militiaFailure" failure)

									; If the player ever ends up with 3 more failures than
									; successes then he is booted.
									(if (geq failure (add success 3))
										(objSetData gPlayerShip "militiaRank" -1)
										)

									(scrShowPane gScreen "Default")
									)
							</Action>
						</Actions>
					</MissionFailure>

					<MissionInProgress
							desc="&quot;What is your major malfunction!? Get back out there and complete your mission!&quot;">

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								<Exit/>
							</Action>
						</Actions>
					</MissionInProgress>

					<MissionSuccess
							desc="&quot;Good work, captain! That was an outstanding mission.&quot;">

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block (promoted)
									(objSetData gSource "MissionStatus" Nil)
									
									; Reset the bar encounter after a successful mission
									(objSetData gSource "NextBarEncounter" Nil)

									; If we're promoted, show the promotion screen. Otherwise,
									; show default.
									(if (milMissionSuccess)
										(milShowPromotionScreen "Main")
										(scrShowPane gScreen "Default")
										)
									)
							</Action>
						</Actions>
					</MissionSuccess>

					<TooManyFailures
							desc="&quot;How about getting us a cup of tea or something? That's probably a mission you could handle.&quot;">

						<Actions>
							<Action name="Leave" default="1" cancel="1" key="L">
								<ShowPane pane="Default"/>
							</Action>
						</Actions>
					</TooManyFailures>

					<DockServices
							desc=	"Your ship is docked.">

						<Actions>
							<Action name="Refuel" key="R">
								(block Nil
									(setq gPrevScreen "Main")
									(setq gPrevPane "DockServices")
									(intSetCompatibleFuel '((&itHeliumAssembly; 75) (&itHelium3FuelRod; 25)))
									(scrShowScreen gScreen "&dsRefuel;")
									)
							</Action>

							<Action name="Repair or replace armor" key="A" >
								(block Nil
									(setq gPrevScreen "Main")
									(setq gPrevPane "DockServices")
									(setq gTechLevel 8)
									(setq gArmorSegment 0)
									(setq gCheckMilitaryID True)
									(setq gMargin 100)
									(scrShowScreen gScreen "&dsRepairArmor;")
									)
							</Action>

							<Action name="Install device" key="D" >
								(block Nil
									(setq gPrevScreen "Main")
									(setq gPrevPane "DockServices")
									(setq gTechLevel 7)
									(setq gTechModifier Nil)
									(setq gCheckMilitaryID True)
									(setq gMargin 100)
									(scrShowScreen gScreen "&dsInstallDevice;")
									)
							</Action>

							<Action name="Remove device" key="V" >
								(block Nil
									(setq gPrevScreen "Main")
									(setq gPrevPane "DockServices")
									(setq gMargin 100)
									(scrShowScreen gScreen "&dsRemoveDevice;")
									)
							</Action>

							<Action name="Done" cancel="1" key="N">
								<ShowPane pane="Default"/>
							</Action>

						</Actions>

					</DockServices>

					<OfficersClub
							desc=	"The Officer's Club is packed with pilots and other officers having a few drinks to pass away the off-duty hours.">

						<Actions>
							<Action name="Sit at the bar" key="S" default="1">
								(if (geq (plyGetCredits gPlayer) 5)
									(block Nil
										(plyCharge gPlayer 5)
										(scrShowPane gScreen "BarEncounter")
										)
									(scrShowPane gScreen "NoMoney")
									)
							</Action>

							<Action name="Leave" cancel="1" key="L">
								<ShowPane pane="Default"/>
							</Action>
						</Actions>
					</OfficersClub>

					<BarEncounter>
						<Initialize>
							(block (rank)
								(setq rank (objGetData gPlayerShip "militiaRank"))
								(setq gResult Nil)

								(switch
									; If the player is black-listed, then she is not welcome
									(eq rank -1)
										(scrSetDesc gScreen "You spend 5 credits on drinks, but everyone avoids you. You feel out of place here.")

									; Make sure enough time passes between encounters
									(and (objGetData gSource "NextBarEncounter")
											(ls (unvGetTick) (objGetData gSource "NextBarEncounter")))
										(scrSetDesc gScreen "You spend 5 credits on drinks, but there aren't too many people here that you want to talk to.")

									; If the player is a major, there is a chance of a henchman
									(and (eq rank 2) (leq (random 1 100) 60) (not (typGetGlobalData &scRoninJenna; "status")))
										(block Nil
											(scrSetDesc gScreen "A young woman in a flight-suit and Commonwealth insignia sits next to you: \"I've seen you in action out there&#x97;you're not too bad for an old-timer.\"")
											(setq gResult "jenna")
											)

									; If the player is a colonel, then another chance for a henchman
									(and (eq rank 3) (leq (random 1 100) 80) (not (typGetGlobalData &scCenturionRama; "status")))
										(block Nil
											(scrSetDesc gScreen "You talk to Rama, a silver-haired pilot who seems to be wearing blaster armor under his flight-suit. You trade stories about flying and fighting, but when you mention your journey to the Core, he grows quiet and stares off into space.")
											(setq gResult "rama")
											)

									; Otherwise, we get rumors
									(block Nil
										(scrSetDesc gScreen (random (objGetStaticData gSource "Rumors")))
										(setq gResult "rumor")
										)
									)

								; Set the time for the next encounter
								(if gResult
									(objSetData gSource "NextBarEncounter" (add (unvGetTick) (random 1500 2000)))
									)
								)
						</Initialize>

						<Actions>
							<Action name="Continue" key="C" default="1" cancel="1">
								(switch
									(eq gResult "jenna")
										(scrShowPane gScreen "Jenna")

									(eq gResult "rama")
										(scrShowPane gScreen "Rama")

									(scrShowPane gScreen "OfficersClub")
									)
							</Action>
						</Actions>
					</BarEncounter>

					<Jenna
							desc="&quot;I'm a pretty good pilot myself. What do you think about you and me taking on the bad guys together?&quot;">

						<Actions>
							<Action name="&quot;OK, you can come along.&quot;" default="1" key="O">
								<ShowPane pane="JennaOK"/>
							</Action>

							<Action name="&quot;Sorry, kid, I travel alone.&quot;" cancel="1" key="S">
								<ShowPane pane="JennaSorry"/>
							</Action>
						</Actions>
					</Jenna>

					<JennaOK
							desc="&quot;Awesome! You won't regret it, I promise!&quot;">

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block (ship)
									; Create the ship
									(setq ship (sysCreateShip &scRoninJenna; gSource &svCommonwealth;))
									(objFireEvent ship "OrderJoinPlayer")

									(scrShowPane gScreen "OfficersClub")
									)
							</Action>
						</Actions>
					</JennaOK>

					<JennaSorry
							desc="&quot;Yeah, well, I didn't think it would work out either.&quot; She leaves you and starts to talk to another pilot at the bar.">

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									; Can't encounter Jenna again
									(typSetGlobalData &scRoninJenna; "status" 'declined)
									
									(scrShowPane gScreen "OfficersClub")
									)
							</Action>
						</Actions>
					</JennaSorry>

					<Rama
							desc="Rama talks about his ship instead: &quot;I've made a lot of modifications to her over the years. You should see her in a fight: fast and tight as a lightship, but heavily armed. She's saved my life a hundred times.&quot;">

						<Actions>
							<Action name="&quot;Why don't you travel with me to the Core?&quot;" default="1" key="C">
								<ShowPane pane="RamaOK"/>
							</Action>

							<Action name="&quot;Well, nice talking with you. Bye.&quot;" cancel="1" key="B">
								<ShowPane pane="RamaSorry"/>
							</Action>
						</Actions>
					</Rama>

					<RamaOK
							desc="Rama pauses for a long time, and when he speaks it is in a whisper. &quot;When I became a man, I went to see a monk about my future. He told me that I was destined to die on a journey to the Core.&quot; And then, Rama laughs and dispatches the rest of his drink. &quot;But I no longer fear my destiny. I will go with you!&quot;">

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block (ship)
									; Create the ship
									(setq ship (sysCreateShip &scCenturionRama; gSource &svCommonwealth;))
									(objFireEvent ship "OrderJoinPlayer")

									(scrShowPane gScreen "OfficersClub")
									)
							</Action>
						</Actions>
					</RamaOK>

					<RamaSorry
							desc="As you get up to leave, Rama grabs your arm and says, &quot;Perhaps we will see each other again.&quot;">

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									; Can't encounter Rama again
									(typSetGlobalData &scCenturionRama; "status" 'declined)

									(scrShowPane gScreen "OfficersClub")
									)
							</Action>
						</Actions>
					</RamaSorry>

					<NoMoney
							desc=	"You sit at the bar, but you don't even have enough money to buy a drink. You feel out of place.">

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								<ShowPane pane="OfficersClub"/>
							</Action>
						</Actions>

					</NoMoney>

				</Panes>
			</Main>

		</DockScreens>

		<DockingPorts>
			<Port x="0"		y="100" />
			<Port x="-80"	y="40" />
			<Port x="80"	y="40" />
			<Port x="-60"	y="-40" />
			<Port x="60"	y="-40" />

			<Port x="0"		y="-105" />
			<Port x="-130"	y="-17" />
			<Port x="130"	y="-17" />
			<Port x="-70"	y="105" />
			<Port x="70"	y="105" />
		</DockingPorts>

	</StationType>

	<!-- Centurion wreck -->

	<StationType UNID="&stCenturionWreck;"
			name=				"(Centurion wreck)"
			sovereign=			"&svCommonwealth;"
			dockScreen=			"&dsAbandonedShip;"
			dockingPorts=		"4"
			scale=				"ship"
			mobile=				"true"
			noMapIcon=			"true"

			ejectaType=			"&vtWreckEjecta;"

			attributes=			"debris,friendly,shipwreck"
			levelFrequency=		"----- rucur ----- ----- -----"
			locationCriteria=	"-planetary"
			>
		<Image shipwreckID="&scCenturion;"/>

		<Items>
			<Table>
				<Null	chance="20"/>
				<Item	chance="30" count="2d6" item="&itHeliumAssembly;"/>
				<Item	chance="20" count="1d4" item="&itBlastPlate;"/>
				<Item	chance="5"  count="1"	item="&itTeV9Blaster;"/>
				<Item	chance="5"  count="1"	item="&itR1Deflector;"/>
				<Lookup chance="10" count="1"	table="&trConsumables7;"/>
				<Lookup chance="5"  count="1"	table="&trMinorItem7;"/>
				<Lookup chance="5"  count="1"	table="&trMajorItem7;"/>
			</Table>
		</Items>

		<Events>
			<GetExplosionType>
				(intContainerGetExplosionType gSource)
			</GetExplosionType>

			<OnDamage>
				(intContainerOnDamage gSource aDamageHP)
			</OnDamage>
		</Events>

	</StationType>

	<!-- Sandstorm wreck -->

	<StationType UNID="&stSandstormWreck;"
			name=				"(Sandstorm wreck)"
			sovereign=			"&svAres;"
			dockScreen=			"&dsAbandonedShip;"
			dockingPorts=		"4"
			scale=				"ship"
			mobile=				"true"
			noMapIcon=			"true"

			ejectaType=			"&vtWreckEjecta;"

			attributes=			"debris,friendly,shipwreck"
			levelFrequency=		"----- rucur ----- ----- -----"
			locationCriteria=	"-planetary"
			>
		<Image shipwreckID="&scSandstorm;"/>

		<Items>
			<Table>
				<Null	chance="40"/>
				<Item	chance="15" count="2d6" item="&itHeliumAssembly;"/>
				<Item	chance="10" count="1d4" item="&itLightTharsisPlate;"/>
				<Item	chance="5"  count="1"	item="&itLightningCannon;"/>
				<Lookup chance="15" count="1"	table="&trConsumables7;"/>
				<Lookup chance="10" count="1"	table="&trMinorItem7;"/>
				<Lookup chance="5"  count="1"	table="&trMajorItem7;"/>
			</Table>
		</Items>

		<Events>
			<GetExplosionType>
				(intContainerGetExplosionType gSource)
			</GetExplosionType>

			<OnDamage>
				(intContainerOnDamage gSource aDamageHP)
			</OnDamage>
		</Events>

	</StationType>

	<!-- Point Juno System -->

	<SystemType UNID="&ssPointJuno;" noRandomEncounters="true">

		<SystemGroup>

			<Station type="&stA-TypeStar;" name="Zheling"/>

			<!-- Zheling I is volcanic world -->

			<Orbitals distance="75-85" angle="random">
				<Group>
					<Primary>
						<Station type="&stVolcanicPlanet;" name="Zheling I"	showOrbit="true"/>
					</Primary>

					<Orbitals distance="10-14" angle="random">
						<Lookup table="StargateOutbound"/>
					</Orbitals>
				</Group>
			</Orbitals>

			<!-- Zheling II is a desert world with a moon -->

			<Orbitals distance="155-165" angle="255-285">
				<Group>
					<Primary>
						<Station type="&stDesertPlanet;" name="Zheling II" showOrbit="true"/>
					</Primary>

					<Orbitals distance="7-12" angle="random">
						<Lookup table="StargateInbound"/>
					</Orbitals>

					<Orbitals distance="18-24" angle="random">
						<Station type="&stLargeAsteroid;"/>
					</Orbitals>

				</Group>
			</Orbitals>

			<!-- Zheling III is a greenhouse world -->

			<Orbitals distance="240-270" angle="100-190">
				<Group>
					<Primary>
						<Station type="&stGreenhousePlanet;" name="Zheling III" showOrbit="true"/>
					</Primary>

					<Orbitals distance="10-16" angle="random">
						<Station type="&stAresCommune;"/>
					</Orbitals>

					<!-- Nebula at the third planetary orbit -->

					<Trojan offset="120">
						<SpaceEnvironment 
								type=			"&seNebula;"
								shape=			"arc" 
								width=			"120"
								widthVariation=	"60"
								span=			"90-120"

								patchType=		"&efNebula;"
								patchFrequency=	"50"

								encountersCount="1d4"
								>
						</SpaceEnvironment>
					</Trojan>

				</Group>
			</Orbitals>

			<!-- Point Juno is near close to the orbit of Zheling III -->

			<Orbitals distance="240-270" angle="255-285">
				<Station type="&stPointJuno;"/>
			</Orbitals>

			<!-- Zheling IV is a gas giant -->

			<Orbitals distance="360-400" angle="30-75">
				<Group>
					<Primary>
						<Station type="&stHydrogenGasGiant;" name="Zheling Iv" showOrbit="true"/>
					</Primary>

					<Orbitals count="4d12" distance="2d6+4" eccentricity="20-40" angle="random">
						<Table>
							<Station chance="75" type="&stSmallFrostAsteroid;" />
							<Station chance="25" type="&stMediumFrostAsteroid;" />
						</Table>
					</Orbitals>

					<Orbitals distance="16-24" angle="random">
						<Station type="&stAresCommune;"/>
					</Orbitals>

					<Trojan>
						<Group>
							<Orbitals count="2d4+4" distance="2d8+8" angle="random">
								<Lookup table="AsteroidSmall"/>
							</Orbitals>

							<Orbitals count="1d6" distance="2d8+8" angle="random">
								<Lookup table="AsteroidMedium"/>
							</Orbitals>

						</Group>
					</Trojan>

					<AntiTrojan>
						<Group>
							<Orbitals count="2d4+4" distance="2d8+8" angle="random">
								<Lookup table="AsteroidSmall"/>
							</Orbitals>

							<Orbitals count="1d6" distance="2d8+8" angle="random">
								<Lookup table="AsteroidMedium"/>
							</Orbitals>

						</Group>
					</AntiTrojan>

					<!-- Nebula at the fourth planetary orbit -->

					<Trojan offset="60">
						<SpaceEnvironment 
								type=			"&seNebula;"
								shape=			"arc" 
								width=			"200"
								widthVariation=	"100"
								span=			"120-160"

								patchType=		"&efNebula;"
								patchFrequency=	"50"

								encountersCount="1d4"
								>
						</SpaceEnvironment>
					</Trojan>

					<AntiTrojan offset="120">
						<SpaceEnvironment 
								type=			"&seNebula;"
								shape=			"arc" 
								width=			"200"
								widthVariation=	"100"
								span=			"120-160"

								patchType=		"&efNebula;"
								patchFrequency=	"50"

								encountersCount="1d4"
								>
						</SpaceEnvironment>
					</AntiTrojan>

				</Group>
			</Orbitals>

			<!-- Zheling V is a methane giant -->

			<Orbitals distance="600-660" angle="random">
				<Group>
					<Primary>
						<Station type="&stMethaneGasGiant;" name="Zheling V" showOrbit="true"/>
					</Primary>

					<Orbitals distance="18-20" angle="random">
						<Lookup table="AsteroidMedium"/>
					</Orbitals>

					<Orbitals distance="28-32" angle="random">
						<Station type="&stCrateredPlanet;"/>
					</Orbitals>

					<Orbitals distance="40-44" angle="random">
						<Lookup table="AsteroidMedium"/>
					</Orbitals>

				</Group>
			</Orbitals>

		</SystemGroup>
	</SystemType>

	<!-- Resources -->

	<Image UNID="&rsStationsPointJuno;"	bitmap="Resources\StationsPointJuno.jpg" bitmask="Resources\StationsPointJunoMask.bmp" backColor="0x00000000"/>
	<Image UNID="&rsPointJunoBkgnd;"	bitmap="Resources\PointJuno.jpg" loadOnUse="true" />

</TranscendenceModule>
